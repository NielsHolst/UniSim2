Simulation sim {
  // .steps = 36
  .steps = 6288
  Calendar calendar {
    .initialDateTime = "2017-09-21 00:00:00"
    .timeStep = 1
    .timeUnit = "h"
  }
  Records env {
    .fileName = "env_file_2017.txt"
  }
  Structure structure {
    Stage ageing {
      .initial = 1. // initial g structure
      .inflow = allocation[structuralMassGrowth]
      .instantLossRate = allocation[structuralMassLossRate]
      .duration = 4680 
      .k = 10
    }
    Accumulator respired {
      .change = allocation[structuralMassLoss]
    }
  }
  Area area {
  }
  Box reserves {
    Reserves carbon {
      .initialProportion = 0.8
      .maxProportion = 0.8
      .allocatedProportion = allocation[reservesProportionC]
    }
    Reserves nitrogen {
      .initialProportion = 0.2
      .maxProportion = 0.2
      .allocatedProportion = allocation[reservesProportionN]
    }
  }
  Box demand {
    Box carbon {
      DemandCarbonStructure structure {
        .maxGrowthRate = 0.00022 // calibrated
        .fTemp     = ./fTemp[value]
        .fSalinity = ./fSalinity[value]
        .fArea     = ./fArea[value]
        Trapezoid fTemp {
          .T = env[T]
          .T0    = 0
          .Topt1 = 10 
          .Topt2 = 20
          .Tmax  = 30
        }
        Fsalinity fSalinity {
        }
        Farea fArea {
        }
      }
      DemandCarbonRespiration respiration {
      }
      DemandCarbonReserves reserves {
      }
      DemandCarbonExudation exudation {
        .gamma = 0.001 // calibrated
      }
    }
    Sum carbonTotal {
      .values = ../carbon/*[value]
    }
    Accumulator baseRespiration {
      .change = ../carbon/respiration[value]
    }
    Box nitrogen {
      DemandNitrogenStructure structure {
      }
      DemandNitrogenReserves reserves {
      }
    }
    Sum nitrogenTotal {
      .values = ../nitrogen/*[value]
    }
  }
  Box supply {
    Photosynthesis photosynthesis {
      .k = 0.6
      .alpha = 2.69
      .fTemp  = ./fTemp[value]
      .fNitrogen = ./fNitrogen[value]
      // .I = 0
      Trapezoid fTemp {
        .T = env[T]
        .T0    = 0
        .Topt1 = 0
        .Topt2 = 20
        .Tmax  = 30
      }
      Fnitrogen fNitrogen {
      }
    }
    NitrogenUptake nitrogenUptake {
      Fcurrent fCurrent {
      }
    }
  }
  Allocation allocation {
  }

  Accumulator exuded {
  .change = allocation[supplyCarbonExudation]
}

  OutputR output {
    +monthBreaks = "scale_x_datetime(breaks = date_breaks('months'), labels = date_format('%b'))"
    Box value {
      +structuralMass = structure[mass]
      +area = area[value]
      +reservesC = reserves/carbon[proportion]
      +reservesN = reserves/nitrogen[proportion]
      +exuded = exuded[value]
      +baseRespiration = baseRespiration[value]
    }
    PageR {
      .title = "Environment"
      .xAxis = calendar[dateTime]
      PlotR {
        .ports = (env[T] env[S] env[N] env[I] env[U])
        .ggplot = output[monthBreaks]
      }
    }
    PageR {
      .title = "Demands"
      .xAxis = calendar[dateTime]
      PlotR {
        .ports = (demand/carbon/*[value] demand/carbonTotal[value] demand/nitrogen/*[value] demand/nitrogenTotal[value])
        .ggplot = output[monthBreaks]
      }
    }
    PageR {
      .title = "Scaling factors"
      .xAxis = calendar[dateTime]
      PlotR {
        .ports = (demand/carbon/structure/*[value] photosynthesis/*[value] nitrogenUptake/*[value])
        .ggplot = output[monthBreaks]
      }
    }
    PageR {
      .title = "Allocation"
      .xAxis = calendar[dateTime]
      PlotR {
        .ports = (allocation[MC0] allocation[MC1] allocation[MC2] allocation[MN0]
          allocation[reservesProportionC] allocation[reservesProportionN])
        .ggplot = output[monthBreaks]
      }
    }
    PageR {
      .title = "Growth"
      .xAxis = calendar[dateTime]
      PlotR {
        .ggplot = output[monthBreaks]
        .ports = (output/value[structuralMass] allocation[structuralMassGrowth] output/value[exuded] 
                  structure[senescent] output/value[baseRespiration] output/value[area]  output/value[reservesC] output/value[reservesN]
                  area[lai] photosynthesis[Iabsorbed] photosynthesis[sdRatio] nitrogenUptake[sdRatio])
      }
    }
  }
}